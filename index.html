<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pokémon Toolbox</title>
    <style>
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #333;
            margin: 0;
            padding: 0;
            min-height: 100vh; /* WICHTIG: Erlaubt dem Body zu wachsen */
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Nimmt den verfügbaren Platz ein */
        }

        .header, nav, .tool-container, .footer-links {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0; /* Verhindert, dass diese Elemente schrumpfen */
        }

        .header {
            text-align: center;
            padding: 30px;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
        }

        .header-donation-call {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 20px;
            font-size: 0.9em;
        }

        .header-donation-call a {
            background-color: #FF5E5E;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        .header-donation-call a:hover {
            background-color: #E04B4B;
        }

        nav {
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        nav button {
            padding: 10px 20px;
            border: none;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 1em;
            border-radius: 8px;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        nav button.active {
            background-color: #667eea;
            color: white;
        }

        .view {
            display: none;
            flex-grow: 1;
            min-height: 0; /* Wichtig für Flexbox in einigen Browsern */
        }

        .view.active {
            display: flex; /* Ansicht soll Flex-Container sein */
            flex-direction: column;
        }
        
        .tool-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
        }

        .scroll-wrapper {
            overflow-y: auto; /* Fügt Scrollbalken nur bei Bedarf hinzu */
        }


        .tool-container h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            color: #447D9B;
        }
        
        select, input[type="text"], .controls button, .quiz-controls button {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            height: 40px;
            box-sizing: border-box;
            font-size: 1em;
            vertical-align: middle;
            margin: 0;
        }

        .progress-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .progress-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            flex-grow: 1;
            max-width: 48%;
            min-width: 280px;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .progress-fill {
            height: 100%;
            text-align: center;
            color: white;
            line-height: 25px;
            font-weight: bold;
            transition: width 0.4s ease-in-out;
        }

        .normal-progress { background: linear-gradient(90deg, #4CAF50, #45a049); }
        .shiny-progress { background: linear-gradient(90deg, #FFD700, #FFA500); }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-grow: 1;
            align-items: center;
            justify-content: flex-start;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .filter-group select,
        .filter-group input[type="text"] {
            flex-grow: 1;
            max-width: 200px;
            min-width: 120px;
        }
        
        .filter-group #searchFilter { max-width: 300px; }
        .button-group button { flex-shrink: 0; white-space: nowrap; }

        .generation-section {
            background: transparent;
            border-radius: 15px;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .generation-header {
            background: #447D9B;
            color: white;
            padding: 15px;
            font-size: 1.2em;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .pokemon-card {
            background: #fafafa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pokemon-card[class*="form-"] {
            border-width: 1.5px;
        }
        .pokemon-card.form-alola {
            background-color: hsl(207, 74%, 96%);
            border-color: #3498db;
        }
        .pokemon-card.form-galar {
            background-color: hsl(9, 86%, 96%);
            border-color: #e74c3c;
        }
        .pokemon-card.form-hisui {
            background-color: hsl(283, 39%, 96%);
            border-color: #9b59b6;
        }
        .pokemon-card[class*="form-paldea"] {
            background-color: hsl(45, 100%, 96%);
            border-color: #f39c12;
        }

        .pokemon-header { display: flex; justify-content: space-between; }
        .pokemon-name { font-weight: bold; color: #4CAF50; }
        .pokemon-name-wrapper { display: flex; align-items: center; }
        .checkbox-group { display: flex; align-items: center; gap: 5px; }
        .checkbox-container { margin-top: auto; }

        .pokewiki-link {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
        }

        .form-tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 4px;
            color: white;
            margin-left: 8px;
        }
        
        /* --- NEUE, UMFASSENDE FARBEN FÜR ALLE FORMEN --- */
        .form-tag.form-abendmahne { background-color: #C70039; }
        .form-tag.form-alola { background-color: #3498DB; }
        .form-tag.form-alle-formen { background-color: #6c757d; }
        .form-tag.form-angriffsform { background-color: #F39C12; }
        .form-tag.form-blutmond { background-color: #E74C3C; }
        .form-tag.form-brunnenmaske { background-color: #2980B9; }
        .form-tag.form-buyo-stil { background-color: #8E44AD; }
        .form-tag.form-cheerleading-stil { background-color: #F1C40F; }
        .form-tag.form-ewigblutler { background-color: #E91E63; }
        .form-tag.form-flamenco-stil { background-color: #E67E22; }
        .form-tag.form-flammenvariante { background-color: #D35400; }
        .form-tag.form-flie-ender-stil { background-color: #3498DB; }
        .form-tag.form-flutenvariante { background-color: #1ABC9C; }
        .form-tag.form-fokussierter-stil { background-color: #2C3E50; }
        .form-tag.form-formen-au-er-ewigblutler { background-color: #7F8C8D; }
        .form-tag.form-frost-form { background-color: #3498DB; }
        .form-tag.form-fundamentmaske { background-color: #A93226; }
        .form-tag.form-galar { background-color: #E74C3C; }
        .form-tag.form-gefechtvariante { background-color: #C0392B; }
        .form-tag.form-gesangsform { background-color: #9B59B6; }
        .form-tag.form-heldenhafter-krieger { background-color: #F1C40F; }
        .form-tag.form-hisui { background-color: #9B59B6; }
        .form-tag.form-hitze-form { background-color: #E67E22; }
        .form-tag.form-hoch-form { background-color: #F39C12; }
        .form-tag.form-hula-stil { background-color: #E91E63; }
        .form-tag.form-inkarnationsform { background-color: #27AE60; }
        .form-tag.form-initiativeform { background-color: #2ECC71; }
        .form-tag.form-klingenform { background-color: #BDC3C7; }
        .form-tag.form-konig-des-schildes { background-color: #34495E; }
        .form-tag.form-konig-des-schwertes { background-color: #3498DB; }
        .form-tag.form-landform { background-color: #27AE60; }
        .form-tag.form-lumpenumhang { background-color: #7F8C8D; }
        .form-tag.form-mega { background-color: #f39c12; }
        .form-tag.form-meteorform { background-color: #95A5A6; }
        .form-tag.form-morgenschwingen { background-color: #8E44AD; }
        .form-tag.form-nachtform { background-color: #2C3E50; }
        .form-tag.form-ofenmaske { background-color: #E67E22; }
        .form-tag.form-optimum { background-color: #16A085; }
        .form-tag.form-pflanzenumhang { background-color: #2ECC71; }
        .form-tag.form-proto { background-color: #D35400; }
        .form-tag.form-rappenreiter { background-color: #735797; }
        .form-tag.form-regenform { background-color: #3498DB; }
        .form-tag.form-sandumhang { background-color: #D35400; }
        .form-tag.form-schimmelreiter { background-color: #96D9D6; }
        .form-tag.form-schneid-form { background-color: #1ABC9C; }
        .form-tag.form-schneeform { background-color: #ECF0F1; color: #333 !important; }
        .form-tag.form-schwarmform { background-color: #2980B9; }
        .form-tag.form-stellarform { background-color: #F1C40F; }
        .form-tag.form-tagform { background-color: #F39C12; }
        .form-tag.form-tanzform { background-color: #E74C3C; }
        .form-tag.form-terakristall-form { background-color: #8E44AD; }
        .form-tag.form-tief-form { background-color: #2980B9; }
        .form-tag.form-tiergeistform { background-color: #D35400; }
        .form-tag.form-trance-modus { background-color: #8E44AD; }
        .form-tag.form-truhenform { background-color: #795548; }
        .form-tag.form-turkisgrune-maske { background-color: #1ABC9C; }
        .form-tag.form-ultra { background-color: #F1C40F; }
        .form-tag.form-unendynamax { background-color: #E91E63; }
        .form-tag.form-urform { background-color: #9B59B6; }
        .form-tag.form-verteidigungsform { background-color: #2980B9; }
        .form-tag.form-wandelform { background-color: #7F8C8D; }
        .form-tag.form-wanderform { background-color: #BDC3C7; }
        .form-tag.form-wasch-form { background-color: #3498DB; }
        .form-tag.form-wirbel-form { background-color: #A98FF3; }
        .form-tag.form-zenitform { background-color: #2ECC71; }
        .form-tag.form-zwielichtform { background-color: #E67E22; }


        .pokemon-types { display: flex; gap: 5px; flex-wrap: wrap; }

        .type-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .type-normal { background-color: #A8A77A; }
        .type-feuer { background-color: #EE8130; }
        .type-wasser { background-color: #6390F0; }
        .type-pflanze { background-color: #7AC74C; }
        .type-elektro { background-color: #F7D02C; }
        .type-eis { background-color: #96D9D6; }
        .type-kampf { background-color: #C22E28; }
        .type-gift { background-color: #A33EA1; }
        .type-boden { background-color: #E2BF65; }
        .type-flug { background-color: #A98FF3; }
        .type-psycho { background-color: #F95587; }
        .type-kaefer { background-color: #729F3F; }
        .type-gestein { background-color: #B6A136; }
        .type-geist { background-color: #735797; }
        .type-drache { background-color: #6F35FC; }
        .type-unlicht { background-color: #705746; }
        .type-stahl { background-color: #B7B7CE; }
        .type-fee { background-color: #D685AD; }

        #type-calculator-view .controls {
            flex-direction: column;
            align-items: center;
            margin-top: 0;
        }

        .utility-button {
            padding: 8px 15px;
            font-size: 0.9em;
            color: #fff;
            background-color: #6c757d;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 0;
        }

        .utility-button:hover { background-color: #5a6268; }

        .pokedex-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f1f3f5;
            border-bottom: 1px solid #dee2e6;
        }

        .pokedex-filters input, .pokedex-filters select {
            flex-grow: 1; min-width: 120px; max-width: 250px; box-sizing: border-box;
        }

        .type-selection-grid {
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 15px;
        }

        .type-selection-grid .type-tag {
            transition: transform 0.2s, box-shadow 0.2s; padding: 8px 12px; font-size: 1em; font-weight: bold;
        }

        .type-selection-grid .type-tag.selected {
            transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #calculator-results {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
        }

        .result-column {
            background-color: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #dee2e6;
        }

        .effectiveness-group { margin-bottom: 10px; }
        .effectiveness-group h4 { font-size: 0.9em; margin: 0 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; }
        .pokedex-clickable .pokemon-card { cursor: pointer; transition: background-color 0.2s; }
        .pokedex-clickable .pokemon-card:hover { background-color: #e9e9e9; }

        .stats-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; align-items: center; }
        .stat-label { font-weight: bold; font-size: 0.9em; }

        .stat-bar-background {
            background-color: #e9ecef; border-radius: 6px; height: 18px; width: 100%; border: 1px solid #dee2e6;
        }

        .stat-bar-fill {
            height: 100%; border-radius: 5px; background: linear-gradient(90deg, #fd7e14, #ffc107);
            transition: width 0.5s ease-out; color: #333; font-size: 0.8em; line-height: 18px;
            font-weight: bold; text-align: center; box-sizing: border-box;
        }

        /* --- Quiz Styles --- */
        .quiz-container { text-align: center; }
        .quiz-stats { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 1.2em; }
        .quiz-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        #quiz-question-area { min-height: 150px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; flex-direction: column; }
        #quiz-question-area .pokemon-card { width: 250px; }
        #quiz-question-area h3 { margin-bottom: 15px; }
        #quiz-feedback { margin-top: 15px; font-size: 1.1em; font-weight: bold; }
        #quiz-feedback.correct { color: #28a745; }
        #quiz-feedback.incorrect { color: #dc3545; }
        #quiz-answer-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; pointer-events: auto; }
        #quiz-answer-grid.disabled { pointer-events: none; }
        #quiz-answer-grid .type-tag { border: 2px solid transparent; transition: opacity 0.3s ease-in-out, transform 0.2s ease, border-color 0.2s ease; }
        #quiz-answer-grid .type-tag.selected { border: 2px solid #007bff; transform: scale(1.1); }
        #quiz-answer-grid .type-tag.faded { opacity: 0.25; }

        #quiz-answer-grid .type-tag {
            font-size: 1.1em; font-weight: bold; padding: 10px 18px; border-radius: 8px;
        }

        .quiz-action-buttons {
            margin-top: 20px; display: flex; flex-direction: column;
            align-items: center; gap: 10px;
        }

        .quiz-action-buttons button {
            font-size: 1.1em; padding: 12px 24px; height: auto; width: 280px;
        }
        
        #codeModal { display: flex; }
        
        .footer-links {
            text-align: center;
            padding: 15px;
            margin-bottom: 0;
        }
        .footer-links a { color: #667eea; text-decoration: none; margin: 0 10px; font-size: 0.9em; }
        .footer-links a:hover { text-decoration: underline; }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            .header h1 {
                margin-bottom: 15px;
            }
            .header-donation-call {
                position: static;
                transform: none;
                margin-top: 10px;
            }
            
            .controls { flex-direction: column; align-items: stretch; }
            .filter-group, .button-group { flex-direction: column; width: 100%; }
            .filter-group select, .filter-group input { max-width: none; }
            
            .pokemon-grid { grid-template-columns: 1fr; }

            .quiz-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .quiz-controls select,
            .quiz-controls button {
                width: 100%;
            }
        }

        /* --- Richtige Antworten im Quiz hervorheben --- */
		#quiz-answer-grid .type-tag.highlight-correct {
			border: 3px solid #28a745;
			box-shadow: 0 0 8px #28a745;
			transform: scale(1.05);
		}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pokémon Toolbox</h1>
            <div class="header-donation-call">
                <a href="https://ko-fi.com/lokthran" target="_blank" rel="noopener noreferrer">Webseite unterstützen (Spende)</a>
            </div>
        </div>
        <nav>
            <button id="nav-living-dex" class="active">Living-Dex</button>
            <button id="nav-type-calculator">Typen-Rechner</button>
            <button id="nav-type-quiz">Typen-Quiz</button>
        </nav>

        <div id="living-dex-view" class="view active">
             <div class="tool-container">
                <div class="scroll-wrapper">
                    <h2>Living-Dex Tracker</h2>
                    <div class="progress-section">
                        <div class="progress-card"><h3>Normal gefangen</h3><div class="progress-bar"><div class="progress-fill normal-progress" id="normalProgress">0%</div></div><div id="normalStats">0 / 0</div></div>
                        <div class="progress-card"><h3>Shiny gefangen</h3><div class="progress-bar"><div class="progress-fill shiny-progress" id="shinyProgress">0%</div></div><div id="shinyStats">0 / 0</div></div>
                    </div>
                    <div class="controls">
                        <div class="filter-group">
                            <select id="genFilter"><option value="all">Alle Generationen</option></select>
                            <select id="formFilter"><option value="all">Alle Formen</option></select>
                            <select id="statusFilter"><option value="all">Alle</option></select>
                            <input type="text" id="searchFilter" placeholder="Nach Name suchen..." />
                        </div>
                        <div class="button-group">
                            <button id="exportCodeBtn" class="utility-button">Pokémon exportieren</button>
                            <button id="importCodeBtn" class="utility-button">Pokémon importieren</button>
                        </div>
                    </div>
                    <div id="pokemonContainer"></div>
                </div>
            </div>
        </div>
        
        <div id="type-calculator-view" class="view">
            <div class="tool-container">
                <div class="scroll-wrapper">
                    <h2>Typen-Rechner</h2>
                    <div class="controls">
                        <h3>Wähle bis zu zwei Typen zur Verteidigungs-Analyse:</h3>
                        <div id="type-selection-grid-container"></div>
                        <button id="clear-types-btn" class="utility-button">Auswahl löschen</button>
                    </div>
                    <div id="calculator-results">
                        <div class="result-column"><h3>Defensive</h3><div id="defensive-results"></div></div>
                        <div class="result-column"><h3>Offensive</h3><div id="offensive-results"></div></div>
                        <div class="result-column" id="stats-container" style="display: none;"><h3>Basis-Stats</h3><div id="stats-display"></div></div>
                    </div>
                    <div class="generation-section">
                        <div class="generation-header">Pokédex (Klicken zum Auswählen)</div>
                        <div class="pokedex-filters">
                            <input type="text" id="pokedex-search" placeholder="Namen suchen...">
                            <select id="pokedex-type1-filter"></select>
                            <select id="pokedex-type2-filter"></select>
                        </div>
                        <div id="pokedex-clickable-container" class="pokedex-clickable pokemon-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="type-quiz-view" class="view">
            <div class="tool-container quiz-container">
                <h2>Typen-Quiz</h2>
                <div class="quiz-stats">
                    <div>Score: <span id="quiz-score">0</span></div>
                    <div>Highscore: <span id="quiz-highscore">0</span></div>
                </div>
                <div class="quiz-controls">
                    <select id="quiz-difficulty-select">
                        <option value="1">Level 1: Typen erraten</option>
                        <option value="2">Level 2: Pokémon (mit Typen)</option>
                        <option value="3">Level 3: Pokémon (ohne Typen)</option>
                    </select>
                    <button id="start-quiz-btn" class="utility-button" style="background-color:#28a745;">Quiz starten</button>
                </div>
                <div id="quiz-question-area" style="display: none;"></div>
                <div id="quiz-answer-area" style="display: none;">
                    <p>Welche(r) Typ(en) ist/sind <strong>sehr effektiv</strong>?</p>
                    <div id="quiz-answer-grid"></div>
                    <div id="quiz-feedback"></div>
                    <div class="quiz-action-buttons">
                        <button id="check-quiz-answer-btn" class="utility-button">Antworten</button>
                        <button id="next-quiz-question-btn" class="utility-button" style="display:none; background-color:#17a2b8;">Nächste Frage</button>
                        <button id="cancel-quiz-btn" class="utility-button" style="display:none; background-color:#dc3545;">Quiz abbrechen</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="impressum-view" class="view">
             <div class="tool-container">
                <h2>IMPRESSUM (WORK IN PROGRESS)</h2>
                ...
             </div>
        </div>

        <div id="datenschutz-view" class="view">
             <div class="tool-container">
                <h2>DATENSCHUTZ (WORK IN PROGRESS)</h2>
                ...
             </div>
        </div>
        
        <div id="codeModal" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
            <div style="background:white; padding:20px; border-radius:12px; width:80%; max-width:500px; text-align:center;">
                <h3 id="modalTitle"></h3>
                <textarea id="codeTextarea" rows="5" style="width:calc(100% - 20px); margin-bottom:10px;"></textarea>
                <button id="modalActionBtn" class="utility-button"></button>
                <button id="modalCloseBtn" class="utility-button" style="background-color:#dc3545;">Schließen</button>
            </div>
        </div>

    </div>

    <div class="footer-links">
        <a href="https://github.com/Lokthran/Pokemon-Toolbox" target="_blank" rel="noopener noreferrer">GitHub Repo</a>
        <a href="#" id="footer-impressum-link">Impressum</a>
        <a href="#" id="footer-datenschutz-link">Datenschutz</a>
    </div>

    <script src="pokedex.js"></script>
    <script src="types.js"></script>
    <script src="stats.js"></script>

    <script>
        // --- Globale Variablen ---
        let caughtPokemon = JSON.parse(localStorage.getItem('caughtPokemon')) || {};
        const allTypes = Object.keys(typeMatchups);
        let selectedTypes = [];
        // Quiz Variablen
        let currentQuizScore = 0;
        let quizHighScores = JSON.parse(localStorage.getItem('quizHighScores')) || { '1': 0, '2': 0, '3': 0 };
        let currentQuizQuestion = {};
        let selectedQuizAnswers = [];

        // --- HILFSFUNKTIONEN ---
        function getTypeClassName(type) { return type.toLowerCase().replace('ä', 'ae'); }
        function sanitizeFormForClassName(formName) { return formName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-$/, ''); }


        // --- CORE LOGIC ---
        document.addEventListener("DOMContentLoaded", () => {
            function switchView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                const view = document.getElementById(viewId);
                let buttonId = `nav-${viewId.replace('-view', '')}`;
                let button = document.getElementById(buttonId);
                
                if (!button) {
                    buttonId = `footer-${viewId.replace('-view', '')}-link`;
                    button = document.getElementById(buttonId);
                }

                if (view) view.style.display = 'flex'; 

                const navButton = document.getElementById(`nav-${viewId.replace('-view', '')}`);
                if (navButton) navButton.classList.add('active');
            }

            ['living-dex', 'type-calculator', 'type-quiz'].forEach(id => {
                document.getElementById(`nav-${id}`).addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(`${id}-view`);
                });
            });
            ['impressum', 'datenschutz'].forEach(id => {
                document.getElementById(`footer-${id}-link`).addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(`${id}-view`);
                });
            });

            initLivingDex();
            initTypeCalculator();
            initTypeQuiz();
            switchView('living-dex-view');
        });
        
        function initLivingDex() {
            const genFilter = document.getElementById("genFilter");
            const uniqueGens = [...new Set(pokemonList.map(p => p.generation))].sort((a, b) => a - b);
            if (genFilter.options.length <= 1) genFilter.innerHTML += uniqueGens.map(i => `<option value="${i}">Generation ${i}</option>`).join('');
            
            // --- NEU: Vereinfachter Form-Filter mit Paldea ---
            const formFilter = document.getElementById("formFilter");
            if (formFilter.options.length <= 1) {
                formFilter.innerHTML = `
                    <option value="all">Alle Formen</option>
                    <option value="Alola">Alola</option>
                    <option value="Galar">Galar</option>
                    <option value="Hisui">Hisui</option>
                    <option value="Paldea">Paldea</option>
                `;
            }

            const statusFilter = document.getElementById("statusFilter");
            if (statusFilter.options.length <= 1) statusFilter.innerHTML += ['caught', 'shiny', 'missing'].map(s => `<option value="${s}">${{ caught: 'Gefangen', shiny: 'Shiny', missing: 'Fehlend' }[s]}</option>`).join('');
            ["genFilter", "statusFilter", "formFilter"].forEach(id => document.getElementById(id).addEventListener("change", applyLivingDexFilters));
            document.getElementById("searchFilter").addEventListener("input", applyLivingDexFilters);
            document.getElementById('exportCodeBtn').addEventListener('click', () => openCodeModal('export'));
            document.getElementById('importCodeBtn').addEventListener('click', () => openCodeModal('import'));
            document.getElementById('modalCloseBtn').addEventListener('click', () => document.getElementById('codeModal').style.display = 'none');
            updateLivingDexProgress();
            applyLivingDexFilters();
        }
        function applyLivingDexFilters() {
            const gen = document.getElementById("genFilter").value;
            const status = document.getElementById("statusFilter").value;
            const search = document.getElementById("searchFilter").value.toLowerCase();
            const form = document.getElementById("formFilter").value;
            let filtered = pokemonList.filter(p => {
                const matchesGen = gen === "all" || p.generation == parseInt(gen);
                const matchesSearch = p.name.toLowerCase().includes(search);
                const matchesForm = (form === "all" || p.form.includes(form));
                let matchesStatus = true;
                if (status !== "all") {
                    const isCaught = caughtPokemon[p.id] && caughtPokemon[p.id].normal;
                    const isShiny = caughtPokemon[p.id] && caughtPokemon[p.id].shiny;
                    if (status === "caught") matchesStatus = isCaught;
                    else if (status === "shiny") matchesStatus = isShiny;
                    else if (status === "missing") matchesStatus = !isCaught;
                }
                return matchesGen && matchesSearch && matchesStatus && matchesForm;
            });
            renderLivingDex(filtered);
        }
        
        function renderLivingDex(list) {
            const container = document.getElementById("pokemonContainer");
            container.innerHTML = "";
            const nonCollectibleForms = ['Mega', 'Proto', 'Optimum', 'Unendynamax', 'Schwarmform', 'Terakristall-Form', 'Stellarform', 'Gefechtvariante', 'Flammenvariante', 'Flutenvariante'];
            const collectiblePokemon = list.filter(p => !nonCollectibleForms.some(form => p.form.includes(form)));

            // --- NEU: Angepasste Logik für einzigartige Pokémon ---
            const finalPokemonList = [];
            const seenBaseIds = new Set();
            const regionalFormsKeywords = ["Alola", "Galar", "Hisui", "Paldea"];

            for (const pokemon of collectiblePokemon) {
                const isSpecialRegional = regionalFormsKeywords.some(keyword => pokemon.form.includes(keyword));

                // Regionale Formen immer hinzufügen.
                if (isSpecialRegional) {
                    finalPokemonList.push(pokemon);
                } 
                // Andere Formen (z.B. "Normal") nur hinzufügen, wenn die base_id noch nicht vorkam.
                else if (!seenBaseIds.has(pokemon.base_id)) {
                    finalPokemonList.push(pokemon);
                    seenBaseIds.add(pokemon.base_id);
                }
            }

            const grouped = finalPokemonList.reduce((acc, p) => {
                (acc[p.generation] = acc[p.generation] || []).push(p);
                return acc;
            }, {});

            Object.keys(grouped).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
                const section = document.createElement("div");
                section.className = "generation-section";
                section.innerHTML = `<div class="generation-header">Generation ${gen}</div>`;
                const grid = document.createElement("div");
                grid.className = "pokemon-grid";
                grouped[gen].forEach(p => {
                    const card = document.createElement("div");
                    card.className = "pokemon-card";
                    const formClass = sanitizeFormForClassName(p.form);

                    if (p.form !== 'Normal') {
                        card.classList.add(`form-${formClass}`);
                    }

                    const isNormalCaught = caughtPokemon[p.id] && caughtPokemon[p.id].normal;
                    const isShinyCaught = caughtPokemon[p.id] && caughtPokemon[p.id].shiny;
                    
                    let formTag = p.form !== 'Normal' ? `<span class="form-tag form-${formClass}">${p.form}</span>` : '';
                    let typeTags = (p.type || "").split(' ').filter(Boolean).map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join('');
                    card.innerHTML = `<div class="pokemon-header"><div class="pokemon-name-wrapper"><a class="pokemon-name" href="https://www.pokewiki.de/${encodeURIComponent(p.name)}" target="_blank">${p.name}</a>${formTag}</div><span>#${String(p.base_id).padStart(4, '0')}</span></div><div class="pokemon-types">${typeTags}</div><div class="checkbox-container"><div class="checkbox-group"><input type="checkbox" id="normal-${p.id}" data-id="${p.id}" data-type="normal" ${isNormalCaught ? 'checked' : ''}/><label for="normal-${p.id}">Normal</label></div><div class="checkbox-group"><input type="checkbox" id="shiny-${p.id}" data-id="${p.id}" data-type="shiny" ${isShinyCaught ? 'checked' : ''}/><label for="shiny-${p.id}">Shiny</label></div><a class="pokewiki-link" href="https://www.pokewiki.de/${encodeURIComponent(p.name)}#Fundorte" target="_blank">Fundorte</a></div>`;
                    grid.appendChild(card);
                });
                section.appendChild(grid);
                container.appendChild(section);
            });

            document.querySelectorAll('#living-dex-view .pokemon-card input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const id = parseInt(event.target.dataset.id);
                    const type = event.target.dataset.type;
                    if (!caughtPokemon[id]) caughtPokemon[id] = { normal: false, shiny: false };
                    caughtPokemon[id][type] = event.target.checked;
                    localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                    updateLivingDexProgress();
                    // Optional: applyLivingDexFilters(); // Kann entfernt werden, wenn es zu langsam wird
                });
            });
        }
        
        function updateLivingDexProgress() {
            // --- NEU: Die Logik hier spiegelt jetzt exakt die renderLivingDex-Logik wider ---
            const nonCollectibleForms = ['Mega', 'Proto', 'Optimum', 'Unendynamax', 'Schwarmform', 'Terakristall-Form', 'Stellarform', 'Gefechtvariante', 'Flammenvariante', 'Flutenvariante'];
            const collectiblePokemon = pokemonList.filter(p => !nonCollectibleForms.some(form => p.form.includes(form)));
            
            const displayedPokemonList = [];
            const seenBaseIds = new Set();
            const regionalFormsKeywords = ["Alola", "Galar", "Hisui", "Paldea"];

            for (const pokemon of collectiblePokemon) {
                const isSpecialRegional = regionalFormsKeywords.some(keyword => pokemon.form.includes(keyword));
                if (isSpecialRegional) {
                    displayedPokemonList.push(pokemon);
                } else if (!seenBaseIds.has(pokemon.base_id)) {
                    displayedPokemonList.push(pokemon);
                    seenBaseIds.add(pokemon.base_id);
                }
            }
            const totalPokemonInLivingDex = displayedPokemonList.length;
            
            // Die Zählung der gefangenen Pokémon basiert auf der Liste der angezeigten Pokémon
            let normalCount = 0;
            let shinyCount = 0;
            displayedPokemonList.forEach(p => {
                if (caughtPokemon[p.id] && caughtPokemon[p.id].normal) normalCount++;
                if (caughtPokemon[p.id] && caughtPokemon[p.id].shiny) shinyCount++;
            });

            document.getElementById("normalStats").textContent = `${normalCount} / ${totalPokemonInLivingDex}`;
            document.getElementById("shinyStats").textContent = `${shinyCount} / ${totalPokemonInLivingDex}`;
            const normalPercentage = totalPokemonInLivingDex > 0 ? (normalCount / totalPokemonInLivingDex * 100).toFixed(1) : 0;
            const shinyPercentage = totalPokemonInLivingDex > 0 ? (shinyCount / totalPokemonInLivingDex * 100).toFixed(1) : 0;
            document.getElementById("normalProgress").style.width = `${normalPercentage}%`;
            document.getElementById("normalProgress").textContent = `${normalPercentage}%`;
            document.getElementById("shinyProgress").style.width = `${shinyPercentage}%`;
            document.getElementById("shinyProgress").textContent = `${shinyPercentage}%`;
        }
        function openCodeModal(mode) {
            const modal = document.getElementById('codeModal');
            const modalTitle = document.getElementById('modalTitle');
            const codeTextarea = document.getElementById('codeTextarea');
            const modalActionBtn = document.getElementById('modalActionBtn');
            modal.style.display = 'flex';
            if (mode === 'export') {
                modalTitle.textContent = 'Dein Living-Dex Code';
                codeTextarea.value = exportCaughtPokemon();
                codeTextarea.readOnly = true;
                modalActionBtn.textContent = 'Kopieren';
                modalActionBtn.onclick = () => {
                    codeTextarea.select();
                    document.execCommand('copy');
                    modalActionBtn.textContent = 'Kopiert!';
                    setTimeout(() => modalActionBtn.textContent = 'Kopieren', 2000);
                };
            } else if (mode === 'import') {
                modalTitle.textContent = 'Code einfügen';
                codeTextarea.value = '';
                codeTextarea.readOnly = false;
                modalActionBtn.textContent = 'Importieren';
                modalActionBtn.onclick = () => {
                    importCaughtPokemon(codeTextarea.value);
                    modal.style.display = 'none';
                    updateLivingDexProgress();
                    applyLivingDexFilters();
                };
            }
        }
        function exportCaughtPokemon() {
            const simpleCaughtData = {};
            for (const id in caughtPokemon) {
                const pokemonExistsInList = pokemonList.some(p => p.id === parseInt(id));
                if (pokemonExistsInList && (caughtPokemon[id].normal || caughtPokemon[id].shiny)) {
                    simpleCaughtData[id] = caughtPokemon[id];
                }
            }
            return JSON.stringify(simpleCaughtData);
        }
        function importCaughtPokemon(code) {
            try {
                const importedData = JSON.parse(code);
                if (typeof importedData !== 'object' || importedData === null) {
                    alert('Ungültiger Code.'); return;
                }
                if (!confirm('Möchtest du deinen aktuellen Fortschritt überschreiben?')) return;
                caughtPokemon = {};
                for (const id in importedData) {
                    const pokemonId = parseInt(id);
                    if (!isNaN(pokemonId) && pokemonList.some(p => p.id === pokemonId)) {
                        caughtPokemon[pokemonId] = {
                            normal: !!importedData[id].normal,
                            shiny: !!importedData[id].shiny
                        };
                    }
                }
                localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                alert('Fortschritt erfolgreich importiert!');
            } catch (e) {
                alert('Fehler beim Importieren des Codes.');
            }
        }
        function initTypeCalculator() {
            const gridContainer = document.getElementById('type-selection-grid-container');
            if(gridContainer.children.length === 0){
                const grid = document.createElement('div');
                grid.className = 'type-selection-grid';
                gridContainer.appendChild(grid);
                allTypes.forEach(type => {
                    const typeTag = document.createElement('span');
                    typeTag.className = `type-tag type-${getTypeClassName(type)}`;
                    typeTag.textContent = type;
                    typeTag.dataset.type = type;
                    typeTag.addEventListener('click', () => toggleTypeSelection(type));
                    grid.appendChild(typeTag);
                });
            }
            document.getElementById('clear-types-btn').addEventListener('click', clearTypeSelection);
            const type1Select = document.getElementById('pokedex-type1-filter');
            const type2Select = document.getElementById('pokedex-type2-filter');
            if (type1Select.options.length <= 1) {
                const allTypeOptions = `<option value="all">Typ 1</option>` + allTypes.map(t => `<option value="${t}">${t}</option>`).join('');
                type1Select.innerHTML = allTypeOptions;
                type2Select.innerHTML = allTypeOptions.replace('Typ 1', 'Typ 2');
            }
            document.getElementById('pokedex-search').addEventListener('input', applyClickablePokedexFilters);
            type1Select.addEventListener('change', applyClickablePokedexFilters);
            type2Select.addEventListener('change', applyClickablePokedexFilters);
            applyClickablePokedexFilters();
            updateCalculatorResults();
        }
        function toggleTypeSelection(type) {
            const index = selectedTypes.indexOf(type);
            if (index > -1) selectedTypes.splice(index, 1);
            else if (selectedTypes.length < 2) selectedTypes.push(type);
            updateCalculatorUI();
        }
        function clearTypeSelection() {
            selectedTypes = [];
            updateCalculatorUI();
            clearStatsDisplay();
        }
        function updateCalculatorUI() {
            document.querySelectorAll('#type-selection-grid-container .type-tag').forEach(tag => {
                tag.classList.toggle('selected', selectedTypes.includes(tag.dataset.type));
            });
            updateCalculatorResults();
        }
        function updateCalculatorResults() {
            const defensiveResults = {};
            if (selectedTypes.length > 0) {
                allTypes.forEach(attackingType => {
                    let finalMultiplier = 1;
                    selectedTypes.forEach(defendingType => {
                        finalMultiplier *= typeMatchups[defendingType]?.[attackingType] ?? 1;
                    });
                    (defensiveResults[finalMultiplier] = defensiveResults[finalMultiplier] || []).push(attackingType);
                });
            }
            renderResults('defensive-results', defensiveResults);
            const offensiveResults = {};
            if (selectedTypes.length > 0) {
                allTypes.forEach(defendingType => {
                    selectedTypes.forEach(attackingType => {
                        const effectiveness = typeMatchups[defendingType]?.[attackingType] ?? 1;
                        if (!offensiveResults[effectiveness]) offensiveResults[effectiveness] = new Set();
                        offensiveResults[effectiveness].add(defendingType);
                    });
                });
            }
            renderResults('offensive-results', offensiveResults);
        }
        function renderResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = (Object.keys(results).length === 0 || selectedTypes.length === 0) ? '<p>Wähle Typ(en).</p>' : '';
            if (container.innerHTML !== '') return;
            const isDefensive = containerId === 'defensive-results';
            const textMap = isDefensive
                ? { 4: "Sehr effektiv (x4)", 2: "Sehr effektiv (x2)", 0.5: "Nicht sehr effektiv (x0.5)", 0.25: "Kaum effektiv (x0.25)", 0: "Immun (x0)" }
                : { 2: "Sehr effektiv (x2)", 0.5: "Nicht sehr effektiv (x0.5)", 0: "Keine Wirkung (x0)" };
            const order = isDefensive ? [4, 2, 1, 0.5, 0.25, 0] : [2, 1, 0.5, 0];
            order.forEach(multiplier => {
                if (textMap[multiplier]) {
                    const types = results[multiplier] ? Array.from(results[multiplier]).sort() : [];
                    if (types.length > 0) {
                        const group = document.createElement('div');
                        group.className = 'effectiveness-group';
                        group.innerHTML = `<h4>${textMap[multiplier]}</h4>`;
                        const typesContainer = document.createElement('div');
                        typesContainer.className = 'pokemon-types';
                        types.forEach(type => {
                            typesContainer.innerHTML += `<span class="type-tag type-${getTypeClassName(type)}">${type}</span>`;
                        });
                        group.appendChild(typesContainer);
                        container.appendChild(group);
                    }
                }
            });
        }
        function renderClickablePokedex(list = pokemonList) {
            const container = document.getElementById('pokedex-clickable-container');
            container.innerHTML = '';
            list.forEach(p => {
                const card = document.createElement('div');
                card.className = 'pokemon-card';
                const formClass = sanitizeFormForClassName(p.form);
                let formTag = p.form !== 'Normal' ? `<span class="form-tag form-${formClass}">${p.form}</span>` : '';
                let typeTags = (p.type || "").split(' ').filter(Boolean).map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join('');
                card.innerHTML = `<div class="pokemon-header"><span class="pokemon-name">${p.name}</span>${formTag}<span>#${String(p.base_id).padStart(4, '0')}</span></div><div class="pokemon-types">${typeTags}</div>`;
                card.addEventListener('click', () => {
                    selectedTypes = (p.type || "").split(' ').filter(Boolean);
                    updateCalculatorUI();
                    renderStats(p);
                    document.querySelector('#type-calculator-view .tool-container').scrollIntoView({ behavior: 'smooth' });
                });
                container.appendChild(card);
            });
        }
        function applyClickablePokedexFilters() {
            const searchText = document.getElementById('pokedex-search').value.toLowerCase();
            const type1 = document.getElementById('pokedex-type1-filter').value;
            const type2 = document.getElementById('pokedex-type2-filter').value;
            const filteredList = pokemonList.filter(p => {
                const types = (p.type || "").split(' ');
                return p.name.toLowerCase().includes(searchText) && (type1 === 'all' || types.includes(type1)) && (type2 === 'all' || types.includes(type2));
            });
            renderClickablePokedex(filteredList);
        }
        function clearStatsDisplay() { document.getElementById('stats-container').style.display = 'none'; }
        function renderStats(pokemon) {
            const stats = pokemonStats.find(s => s.id === pokemon.id);
            const statsContainer = document.getElementById('stats-container');
            const statsDisplay = document.getElementById('stats-display');
            if (!stats) { clearStatsDisplay(); return; }
            statsContainer.style.display = 'block';
            const maxStatValue = 255;
            statsDisplay.innerHTML = `<div class="stats-grid">
                <span class="stat-label">KP:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.hp / maxStatValue) * 100}%">${stats.hp}</div></div>
                <span class="stat-label">Angriff:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.attack / maxStatValue) * 100}%">${stats.attack}</div></div>
                <span class="stat-label">Verteid.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.defense / maxStatValue) * 100}%">${stats.defense}</div></div>
                <span class="stat-label">Sp. Ang.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.special_attack / maxStatValue) * 100}%">${stats.special_attack}</div></div>
                <span class="stat-label">Sp. Vert.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.special_defense / maxStatValue) * 100}%">${stats.special_defense}</div></div>
                <span class="stat-label">Initiative:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.speed / maxStatValue) * 100}%">${stats.speed}</div></div>
                <span class="stat-label">Gesamt:</span> <span style="font-weight:bold;">${stats.total}</span>
            </div>`;
        }

        function initTypeQuiz() {
            updateHighScoreDisplay();
            const answerGrid = document.getElementById('quiz-answer-grid');
            if (!answerGrid.hasChildNodes()) {
                answerGrid.innerHTML = allTypes.map(type => `<span class="type-tag type-${getTypeClassName(type)}" data-type="${type}">${type}</span>`).join('');
                answerGrid.addEventListener('click', e => {
                    if (e.target.classList.contains('type-tag')) {
                        toggleQuizTypeSelection(e.target.dataset.type);
                    }
                });
            }
            document.getElementById('quiz-difficulty-select').addEventListener('change', updateHighScoreDisplay);
            document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
            document.getElementById('check-quiz-answer-btn').addEventListener('click', checkQuizAnswer);
            document.getElementById('next-quiz-question-btn').addEventListener('click', nextQuizQuestion);
            document.getElementById('cancel-quiz-btn').addEventListener('click', cancelQuiz);
        }

        function updateHighScoreDisplay() {
            const difficulty = document.getElementById('quiz-difficulty-select').value;
            document.getElementById('quiz-highscore').textContent = quizHighScores[difficulty] || 0;
        }

        function startQuiz() {
            document.querySelector('#type-quiz-view .tool-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            currentQuizScore = 0;
            document.getElementById('quiz-score').textContent = currentQuizScore;
            document.querySelector('.quiz-controls').style.display = 'none';
            document.getElementById('quiz-question-area').style.display = 'flex';
            document.getElementById('quiz-answer-area').style.display = 'block';
            document.getElementById('cancel-quiz-btn').style.display = 'inline-block';
            nextQuizQuestion();
        }

        function cancelQuiz() {
            document.querySelector('.quiz-controls').style.display = 'flex';
            document.getElementById('quiz-question-area').style.display = 'none';
            document.getElementById('quiz-answer-area').style.display = 'none';
            document.getElementById('cancel-quiz-btn').style.display = 'none';
            document.getElementById('next-quiz-question-btn').style.display = 'none';
            document.getElementById('check-quiz-answer-btn').style.display = 'inline-block';
            currentQuizScore = 0;
            document.getElementById('quiz-score').textContent = '0';
        }
        
        function generateQuizQuestion() {
            const difficulty = document.getElementById('quiz-difficulty-select').value;
            const questionArea = document.getElementById('quiz-question-area');
            let defendingTypes = [];

            if (difficulty === "1") {
                // --- NEU: Wählt immer nur einen Typ aus ---
                defendingTypes = [allTypes[Math.floor(Math.random() * allTypes.length)]];
                questionArea.innerHTML = `<div class="pokemon-types" style="justify-content: center; margin-top: 10px; transform: scale(1.2);">${defendingTypes.map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join(' ')}</div>`;

            } else {
                const randomPokemon = pokemonList[Math.floor(Math.random() * pokemonList.length)];
                defendingTypes = (randomPokemon.type || "").split(' ').filter(Boolean);
                const formClass = sanitizeFormForClassName(randomPokemon.form);
                let formTag = randomPokemon.form !== 'Normal' ? `<span class="form-tag form-${formClass}">${randomPokemon.form}</span>` : '';
                let typeTags = (randomPokemon.type || "").split(' ').filter(Boolean).map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join('');
                const card = document.createElement('div');
                card.className = 'pokemon-card';
                card.innerHTML = `
                    <div class="pokemon-header" style="margin-top: 10px;">
                        <span class="pokemon-name">${randomPokemon.name}</span>${formTag}
                        <span>#${String(randomPokemon.base_id).padStart(4, '0')}</span>
                    </div>
                    <div class="pokemon-types">${difficulty === "2" ? typeTags : ''}</div>`;
                questionArea.innerHTML = '';
                questionArea.appendChild(card);
            }
            currentQuizQuestion = {
                defendingTypes: defendingTypes,
                correctAnswers: getEffectiveAgainst(defendingTypes)
            };
        }

        function getEffectiveAgainst(defendingTypes) {
            const effectiveTypes = new Set();
            allTypes.forEach(attackingType => {
                let multiplier = 1;
                defendingTypes.forEach(defendingType => {
                    multiplier *= typeMatchups[defendingType]?.[attackingType] ?? 1;
                });
                if (multiplier >= 2) {
                    effectiveTypes.add(attackingType);
                }
            });
            return effectiveTypes;
        }

        function toggleQuizTypeSelection(type) {
            const index = selectedQuizAnswers.indexOf(type);
            const tag = document.querySelector(`#quiz-answer-grid .type-tag[data-type="${type}"]`);
            if (index > -1) {
                selectedQuizAnswers.splice(index, 1);
                tag.classList.remove('selected');
            } else {
                selectedQuizAnswers.push(type);
                tag.classList.add('selected');
            }
        }

      function checkQuizAnswer() {
            const correctAnswers = currentQuizQuestion.correctAnswers;
            const feedbackEl = document.getElementById('quiz-feedback');
            const difficulty = document.getElementById('quiz-difficulty-select').value;
            const isCorrect = selectedQuizAnswers.length === correctAnswers.size && selectedQuizAnswers.every(type => correctAnswers.has(type));

            document.getElementById('quiz-answer-grid').classList.add('disabled');

            if (isCorrect) {
                currentQuizScore++;
                document.getElementById('quiz-score').textContent = currentQuizScore;
                feedbackEl.textContent = 'Richtig!';
                feedbackEl.className = 'correct';
                if (currentQuizScore > (quizHighScores[difficulty] || 0)) {
                    quizHighScores[difficulty] = currentQuizScore;
                    localStorage.setItem('quizHighScores', JSON.stringify(quizHighScores));
                    updateHighScoreDisplay();
                }
            } else {
                currentQuizScore = 0;
                document.getElementById('quiz-score').textContent = currentQuizScore;
                feedbackEl.textContent = 'Leider falsch! Score zurückgesetzt.';
                feedbackEl.className = 'incorrect';
            }

            document.querySelectorAll('#quiz-answer-grid .type-tag').forEach(tag => {
                const type = tag.dataset.type;
                if (correctAnswers.has(type)) {
                    tag.classList.add('highlight-correct');
                } else {
                    tag.classList.add('faded');
                }
            });

            document.getElementById('check-quiz-answer-btn').style.display = 'none';
            document.getElementById('next-quiz-question-btn').style.display = 'inline-block';
        }

        function nextQuizQuestion() {
            selectedQuizAnswers = [];
            document.getElementById('quiz-feedback').textContent = '';
            document.getElementById('quiz-answer-grid').classList.remove('disabled');
            
            document.querySelectorAll('#quiz-answer-grid .type-tag').forEach(tag => {
                tag.className = `type-tag type-${getTypeClassName(tag.dataset.type)}`;
            });

            document.getElementById('check-quiz-answer-btn').style.display = 'inline-block';
            document.getElementById('next-quiz-question-btn').style.display = 'none';
            
            generateQuizQuestion();
        }
    </script>
</body>
</html>