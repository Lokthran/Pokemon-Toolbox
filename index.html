<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pokémon Toolbox</title>
    <style>
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        nav {
            display: flex;
            justify-content: center;
            background-color: white;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

            nav button {
                padding: 10px 20px;
                border: none;
                background-color: #f0f0f0;
                cursor: pointer;
                font-size: 1em;
                border-radius: 8px;
                margin: 0 5px;
                transition: background-color 0.3s;
            }

                nav button.active {
                    background-color: #667eea;
                    color: white;
                }

        .view {
            display: none;
        }

            .view.active {
                display: block;
            }

        /* Einheitliche Höhe und Ausrichtung für alle Steuerelemente im .controls-Kasten */
        select, input[type="text"], .controls button {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            height: 40px;
            box-sizing: border-box;
            font-size: 1em;
            vertical-align: middle;
            margin: 0;
        }

        .progress-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-grow: 1; 
            max-width: 48%; 
            min-width: 280px; 
        }

        .progress-section {
            flex-direction: row; 
            justify-content: space-around; 
            align-items: flex-start; 
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .progress-fill {
            height: 100%;
            text-align: center;
            color: white;
            line-height: 25px;
            font-weight: bold;
            transition: width 0.4s ease-in-out;
        }

        .normal-progress {
            background: linear-gradient(90deg, #4CAF50, #45a049);
        }

        .shiny-progress {
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }

        .controls {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-grow: 1;
            align-items: center;
            justify-content: flex-start;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .filter-group select,
        .filter-group input[type="text"] {
            flex-grow: 1; 
            max-width: 200px; 
            min-width: 120px; 
        }
        
        .filter-group #searchFilter {
            max-width: 300px; 
        }

        .button-group button {
            flex-shrink: 0; 
            white-space: nowrap; 
        }

        .generation-section {
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .generation-header {
            background: #447D9B;
            color: white;
            padding: 15px;
            font-size: 1.2em;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .pokemon-card {
            background: #fafafa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pokemon-header {
            display: flex;
            justify-content: space-between;
        }

        .pokemon-name {
            font-weight: bold;
            color: #4CAF50;
        }

        .pokemon-name-wrapper {
            display: flex;
            align-items: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-container {
            margin-top: auto;
        }

        .pokewiki-link {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
        }

        .form-tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 4px;
            color: white;
            margin-left: 8px;
        }

        .form-Alola {
            background-color: #3498db;
        }

        .form-Galar {
            background-color: #e74c3c;
        }

        .form-Hisui {
            background-color: #9b59b6;
        }

        .pokemon-types {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .type-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .type-normal {
            background-color: #A8A77A;
        }

        .type-feuer {
            background-color: #EE8130;
        }

        .type-wasser {
            background-color: #6390F0;
        }

        .type-pflanze {
            background-color: #7AC74C;
        }

        .type-elektro {
            background-color: #F7D02C;
        }

        .type-eis {
            background-color: #96D9D6;
        }

        .type-kampf {
            background-color: #C22E28;
        }

        .type-gift {
            background-color: #A33EA1;
        }

        .type-boden {
            background-color: #E2BF65;
        }

        .type-flug {
            background-color: #A98FF3;
        }

        .type-psycho {
            background-color: #F95587;
        }

        .type-kaefer {
            background-color: #729F3F;
        }

        .type-gestein {
            background-color: #B6A136;
        }

        .type-geist {
            background-color: #735797;
        }

        .type-drache {
            background-color: #6F35FC;
        }

        .type-unlicht {
            background-color: #705746;
        }

        .type-stahl {
            background-color: #B7B7CE;
        }

        .type-fee {
            background-color: #D685AD;
        }

        #type-calculator-view > .controls {
            flex-direction: column;
            align-items: center;
        }

        .utility-button {
            padding: 8px 15px;
            font-size: 0.9em;
            color: #fff;
            background-color: #6c757d;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 0;
        }

            .utility-button:hover {
                background-color: #5a6268;
            }

        .pokedex-filters {
            display: flex;
            flex-wrap: wrap; /* Erlaubt Umbruch auf mehrere Zeilen */
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f1f3f5;
            border-bottom: 1px solid #dee2e6;
        }

            .pokedex-filters input,
            .pokedex-filters select { /* Hier wurden select-Elemente hinzugefügt */
                flex-grow: 1; /* Ermöglicht diesen Elementen, zu wachsen */
                min-width: 120px; /* Mindestbreite, damit sie nicht zu klein werden */
                max-width: 250px; /* Max-Breite beibehalten */
                box-sizing: border-box; /* Polsterung in die Breite einbeziehen */
            }

        .type-selection-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-bottom: 15px;
        }

            .type-selection-grid .type-tag {
                transition: transform 0.2s, box-shadow 0.2s;
                padding: 8px 12px;
                font-size: 1em;
                font-weight: bold;
            }

                .type-selection-grid .type-tag.selected {
                    transform: scale(1.1);
                    box-shadow: 0 0 10px rgba(0,0,0,0.5);
                }

        #calculator-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .result-column {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }

        .effectiveness-group {
            margin-bottom: 10px;
        }

            .effectiveness-group h4 {
                font-size: 0.9em;
                margin: 0 0 8px 0;
                padding-bottom: 5px;
                border-bottom: 1px solid #f0f0f0;
            }

        .pokedex-clickable .pokemon-card {
            cursor: pointer;
            transition: background-color 0.2s;
        }

            .pokedex-clickable .pokemon-card:hover {
                background-color: #e9e9e9;
            }

        .stats-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 12px;
            align-items: center;
        }

        .stat-label {
            font-weight: bold;
            font-size: 0.9em;
        }

        .stat-bar-background {
            background-color: #e9ecef;
            border-radius: 6px;
            height: 18px;
            width: 100%;
            border: 1px solid #dee2e6;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, #fd7e14, #ffc107);
            transition: width 0.5s ease-out;
            color: #333;
            font-size: 0.8em;
            line-height: 18px;
            font-weight: bold;
            text-align: center;
            box-sizing: border-box;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                justify-content: flex-start;
            }

            .controls select,
            .controls input {
                width: 100%;
                margin-bottom: 10px;
                max-width: unset;
                flex-grow: 1;
            }
            
            .controls button {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }

            .filter-group, .button-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                margin-left: 0;
            }
            
            .filter-group select,
            .filter-group input {
                width: 100%;
                margin-bottom: 10px;
            }

            .button-group button {
                width: 100%;
                margin-top: 10px;
            }

            .pokedex-filters {
                flex-direction: column;
                align-items: stretch;
            }

            /* Hier die Korrektur für die Typ-Filter im Typen-Rechner-Pokédex */
            .pokedex-filters input,
            .pokedex-filters select {
                width: 100%; /* Volle Breite, damit sie nicht über den Rand ragen */
                margin-bottom: 10px;
                flex-shrink: 0; /* Verhindert, dass sie schrumpfen und überlappen */
                max-width: unset; /* Setzt die max-width vom Desktop-Modus zurück */
            }

            .type-selection-grid {
                justify-content: center;
            }

            .pokemon-grid {
                grid-template-columns: 1fr;
            }

            .progress-section {
                flex-direction: column;
                align-items: center;
            }

            .progress-card {
                width: 100%;
                max-width: 350px;
                margin-bottom: 15px;
            }
        }
        /* Styles für das Code-Modal */
        #codeModal {
            display: flex; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Pokémon Toolbox</h1></div>
        <nav>
            <button id="nav-living-dex" class="active">Living-Dex</button>
            <button id="nav-type-calculator">Typen-Rechner</button>
        </nav>
        <div id="living-dex-view" class="view active">
            <div class="progress-section">
                <div class="progress-card"><h3>Normal gefangen</h3><div class="progress-bar"><div class="progress-fill normal-progress" id="normalProgress">0%</div></div><div id="normalStats">0 / 0</div></div>
                <div class="progress-card"><h3>Shiny gefangen</h3><div class="progress-bar"><div class="progress-fill shiny-progress" id="shinyProgress">0%</div></div><div id="shinyStats">0 / 0</div></div>
            </div>
            <div class="controls">
                <div class="filter-group">
                    <select id="genFilter"><option value="all">Alle Generationen</option></select>
                    <select id="formFilter"><option value="all">Alle Formen</option></select>
                    <select id="statusFilter"><option value="all">Alle</option></select>
                    <input type="text" id="searchFilter" placeholder="Nach Name suchen..." />
                </div>
                <div class="button-group">
                    <button id="exportCodeBtn" class="utility-button">Pokémon exportieren</button>
                    <button id="importCodeBtn" class="utility-button">Pokémon importieren</button>
                </div>
            </div>

            <div id="codeModal" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                <div style="background:white; padding:20px; border-radius:12px; width:80%; max-width:500px; text-align:center;">
                    <h3 id="modalTitle"></h3>
                    <textarea id="codeTextarea" rows="5" style="width:calc(100% - 20px); margin-bottom:10px;"></textarea>
                    <button id="modalActionBtn" class="utility-button"></button>
                    <button id="modalCloseBtn" class="utility-button" style="background-color:#dc3545;">Schließen</button>
                </div>
            </div>

            <div id="pokemonContainer"></div>
        </div>
        <div id="type-calculator-view" class="view">
            <div class="controls">
                <h3>Wähle bis zu zwei Typen zur Verteidigungs-Analyse:</h3>
                <div id="type-selection-grid-container"></div>
                <button id="clear-types-btn" class="utility-button">Auswahl löschen</button>
            </div>
            <div id="calculator-results">
                <div class="result-column"><h3>Defensive</h3><div id="defensive-results"></div></div>
                <div class="result-column"><h3>Offensive</h3><div id="offensive-results"></div></div>
                <div class="result-column" id="stats-container" style="display: none;"><h3>Basis-Stats</h3><div id="stats-display"></div></div>
            </div>
            <div class="generation-section" style="margin-top: 20px;">
                <div class="generation-header">Pokédex (Klicken zum Auswählen)</div>
                <div class="pokedex-filters">
                    <input type="text" id="pokedex-search" placeholder="Namen suchen...">
                    <select id="pokedex-type1-filter"></select>
                    <select id="pokedex-type2-filter"></select>
                </div>
                <div id="pokedex-clickable-container" class="pokedex-clickable pokemon-grid"></div>
            </div>
        </div>
    </div>

    <script src="pokedex.js"></script>
    <script src="types.js"></script>
    <script src="stats.js"></script>

    <script>
        // --- Globale Variablen ---
        let caughtPokemon = JSON.parse(localStorage.getItem('caughtPokemon')) || {};
        const allTypes = Object.keys(typeMatchups);
        let selectedTypes = [];

        // --- HILFSFUNKTION FÜR TYP-KLASSENNAMEN ---
        function getTypeClassName(type) {
            return type.toLowerCase().replace('ä', 'ae');
        }

        // --- CORE LOGIC ---
        document.addEventListener("DOMContentLoaded", () => {
            const navLivingDex = document.getElementById('nav-living-dex');
            const navTypeCalc = document.getElementById('nav-type-calculator');
            function showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                (viewId === 'living-dex-view' ? navLivingDex : navTypeCalc).classList.add('active');
            }
            navLivingDex.addEventListener('click', () => showView('living-dex-view'));
            navTypeCalc.addEventListener('click', () => showView('type-calculator-view'));
            initLivingDex();
            initTypeCalculator();
            showView('living-dex-view');
        });

        // --- LIVING DEX FUNCTIONS ---
        function initLivingDex() {
            const genFilter = document.getElementById("genFilter");
            const uniqueGens = [...new Set(pokemonList.map(p => p.generation))].sort((a,b) => a-b);
            genFilter.innerHTML += uniqueGens.map(i => `<option value="${i}">Generation ${i}</option>`).join('');
            const formFilter = document.getElementById("formFilter");
            // Entferne "Mega" aus den Living-Dex-Formfiltern
            const uniqueForms = [...new Set(pokemonList.filter(p => p.form !== 'Mega').map(p => p.form))];
            formFilter.innerHTML += uniqueForms.map(f => `<option value="${f}">${f}</option>`).join('');
            const statusFilter = document.getElementById("statusFilter");
            statusFilter.innerHTML += ['caught', 'shiny', 'missing'].map(s => `<option value="${s}">${{caught:'Gefangen',shiny:'Shiny',missing:'Fehlend'}[s]}</option>`).join('');
            ["genFilter", "statusFilter", "formFilter"].forEach(id => document.getElementById(id).addEventListener("change", applyLivingDexFilters));
            document.getElementById("searchFilter").addEventListener("input", applyLivingDexFilters);
            updateLivingDexProgress();
            applyLivingDexFilters();
        }
        function applyLivingDexFilters() {
            const gen = document.getElementById("genFilter").value;
            const status = document.getElementById("statusFilter").value;
            const search = document.getElementById("searchFilter").value.toLowerCase();
            const form = document.getElementById("formFilter").value;
            
            let filtered = pokemonList.filter(p => {
                // Bedingung: Mega-Entwicklungen IMMER ausschließen
                const isNotMega = p.form !== 'Mega';

                // Überprüfe Generation
                const matchesGen = gen === "all" || p.generation == parseInt(gen);
                
                // Überprüfe Namenssuche
                const matchesSearch = p.name.toLowerCase().includes(search);
                
                // Überprüfe Form: Wenn "all" ausgewählt ist, lasse alle NICHT-Mega-Formen zu. Ansonsten, nur die spezifische Form.
                const matchesForm = (form === "all" || p.form === form);
                
                // Überprüfe Fangstatus
                let matchesStatus = true;
                if (status !== "all") {
                    const isCaught = caughtPokemon[p.id] && caughtPokemon[p.id].normal;
                    const isShiny = caughtPokemon[p.id] && caughtPokemon[p.id].shiny;
                    if (status === "caught") matchesStatus = isCaught;
                    else if (status === "shiny") matchesStatus = isShiny;
                    else if (status === "missing") matchesStatus = !isCaught;
                }
                
                // ALLE Bedingungen müssen erfüllt sein
                return isNotMega && matchesGen && matchesSearch && matchesStatus && matchesForm; 
            });
            renderLivingDex(filtered);
        }
        function renderLivingDex(list) {
            const container = document.getElementById("pokemonContainer");
            container.innerHTML = "";
            const grouped = list.reduce((acc, p) => {
                (acc[p.generation] = acc[p.generation] || []).push(p);
                return acc;
            }, {});
            Object.keys(grouped).sort((a, b) => parseInt(a) - parseInt(b)).forEach(gen => {
                const section = document.createElement("div");
                section.className = "generation-section";
                section.innerHTML = `<div class="generation-header">Generation ${gen}</div>`;
                const grid = document.createElement("div");
                grid.className = "pokemon-grid";
                grouped[gen].forEach(p => {
                    const card = document.createElement("div");
                    card.className = "pokemon-card";
                    const isNormalCaught = caughtPokemon[p.id] && caughtPokemon[p.id].normal;
                    const isShinyCaught = caughtPokemon[p.id] && caughtPokemon[p.id].shiny;
                    let formTag = p.form !== 'Normal' ? `<span class="form-tag form-${p.form}">${p.form}</span>` : '';
                    let typeTags = (p.type || "").split(' ').filter(Boolean).map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join('');
                    card.innerHTML = `<div class="pokemon-header"><div class="pokemon-name-wrapper"><a class="pokemon-name" href="https://www.pokewiki.de/${encodeURIComponent(p.name)}" target="_blank">${p.name}</a>${formTag}</div><span>#${String(p.base_id).padStart(4, '0')}</span></div><div class="pokemon-types">${typeTags}</div><div class="checkbox-container"><div class="checkbox-group"><input type="checkbox" id="normal-${p.id}" data-id="${p.id}" data-type="normal" ${isNormalCaught ? 'checked' : ''}/><label for="normal-${p.id}">Normal</label></div><div class="checkbox-group"><input type="checkbox" id="shiny-${p.id}" data-id="${p.id}" data-type="shiny" ${isShinyCaught ? 'checked' : ''}/><label for="shiny-${p.id}">Shiny</label></div><a class="pokewiki-link" href="https://www.pokewiki.de/${encodeURIComponent(p.name)}#Fundorte" target="_blank">Fundorte</a></div>`;
                    grid.appendChild(card);
                });
                section.appendChild(grid);
                container.appendChild(section);
            });
            document.querySelectorAll('#living-dex-view .pokemon-card input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const id = parseInt(event.target.dataset.id);
                    const type = event.target.dataset.type;
                    if (!caughtPokemon[id]) caughtPokemon[id] = { normal: false, shiny: false };
                    caughtPokemon[id][type] = event.target.checked;
                    localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                    updateLivingDexProgress(); // Update progress bar instantly
                    applyLivingDexFilters(); // Re-apply filters to ensure correct display based on new status
                });
            });
        }
        function updateLivingDexProgress() {
            // Bestimme die Gesamtanzahl der Pokémon im Living-Dex (ohne Mega-Entwicklungen)
            const totalPokemonInLivingDex = pokemonList.filter(p => p.form !== 'Mega').length;

            // Zähle die normal gefangenen Pokémon, die NICHT Mega-Entwicklungen sind
            let normalCount = 0;
            let shinyCount = 0;
            pokemonList.forEach(p => {
                if (p.form !== 'Mega') { // Nur Nicht-Mega-Pokémon berücksichtigen
                    if (caughtPokemon[p.id] && caughtPokemon[p.id].normal) {
                        normalCount++;
                    }
                    if (caughtPokemon[p.id] && caughtPokemon[p.id].shiny) {
                        shinyCount++;
                    }
                }
            });

            // Aktualisiere die Textanzeigen
            document.getElementById("normalStats").textContent = `${normalCount} / ${totalPokemonInLivingDex}`;
            document.getElementById("shinyStats").textContent = `${shinyCount} / ${totalPokemonInLivingDex}`;
            
            // Berechne die Prozentsätze
            const normalPercentage = totalPokemonInLivingDex > 0 ? (normalCount / totalPokemonInLivingDex * 100).toFixed(1) : 0;
            const shinyPercentage = totalPokemonInLivingDex > 0 ? (shinyCount / totalPokemonInLivingDex * 100).toFixed(1) : 0;

            // Aktualisiere die Fortschrittsbalken
            document.getElementById("normalProgress").style.width = `${normalPercentage}%`;
            document.getElementById("normalProgress").textContent = `${normalPercentage}%`;
            document.getElementById("shinyProgress").style.width = `${shinyPercentage}%`;
            document.getElementById("shinyProgress").textContent = `${shinyPercentage}%`;
        }

        // --- IMPORT/EXPORT FUNCTIONS ---
        function openCodeModal(mode) {
            const modal = document.getElementById('codeModal');
            const modalTitle = document.getElementById('modalTitle');
            const codeTextarea = document.getElementById('codeTextarea');
            const modalActionBtn = document.getElementById('modalActionBtn');

            modal.style.display = 'flex'; // Modal anzeigen

            if (mode === 'export') {
                modalTitle.textContent = 'Dein Living-Dex Code';
                codeTextarea.value = exportCaughtPokemon();
                codeTextarea.readOnly = true; // Nur zum Kopieren
                modalActionBtn.textContent = 'Kopieren';
                modalActionBtn.onclick = () => {
                    codeTextarea.select();
                    document.execCommand('copy');
                    modalActionBtn.textContent = 'Kopiert!';
                    setTimeout(() => modalActionBtn.textContent = 'Kopieren', 2000);
                };
            } else if (mode === 'import') {
                modalTitle.textContent = 'Code einfügen';
                codeTextarea.value = '';
                codeTextarea.readOnly = false; // Zum Einfügen
                modalActionBtn.textContent = 'Importieren';
                modalActionBtn.onclick = () => {
                    importCaughtPokemon(codeTextarea.value);
                    modal.style.display = 'none'; // Modal schließen nach Import
                    // Aktualisiere die Anzeige
                    updateLivingDexProgress();
                    applyLivingDexFilters(); 
                };
            }
        }

        function exportCaughtPokemon() {
            // Wir speichern nur die IDs der gefangenen Pokémon und ihren Status
            const simpleCaughtData = {};
            for (const id in caughtPokemon) {
                // Sicherstellen, dass nur IDs aus pokemonList berücksichtigt werden
                const pokemonExistsInList = pokemonList.some(p => p.id === parseInt(id));
                if (pokemonExistsInList && (caughtPokemon[id].normal || caughtPokemon[id].shiny)) {
                    simpleCaughtData[id] = {
                        normal: caughtPokemon[id].normal,
                        shiny: caughtPokemon[id].shiny
                    };
                }
            }
            // JSON.stringify konvertiert das Objekt in einen String
            return JSON.stringify(simpleCaughtData);
        }

        function importCaughtPokemon(code) {
            try {
                const importedData = JSON.parse(code);
                if (typeof importedData !== 'object' || importedData === null) {
                    alert('Ungültiger Code: Das importierte Objekt ist kein gültiges JSON-Objekt.');
                    return;
                }

                // Bestätigungsabfrage vor dem Import
                if (!confirm('Möchtest du deinen aktuellen Fortschritt mit dem importierten Code überschreiben?')) {
                    return; // Import abbrechen
                }

                // Den aktuellen Fortschritt komplett löschen und durch importierte Daten ersetzen
                caughtPokemon = {}; 
                for (const id in importedData) {
                    const pokemonId = parseInt(id);
                    // Zusätzliche Prüfung, ob die ID in unserer pokemonList existiert, um ungültige Daten zu vermeiden
                    if (!isNaN(pokemonId) && pokemonList.some(p => p.id === pokemonId)) { 
                        caughtPokemon[pokemonId] = {
                            normal: !!importedData[id].normal, // !! konvertiert zu echtem Boolean
                            shiny: !!importedData[id].shiny
                        };
                    }
                }
                localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                alert('Fortschritt erfolgreich importiert!');
            } catch (e) {
                alert('Fehler beim Importieren des Codes. Bitte stelle sicher, dass es ein gültiger Code ist.');
                console.error('Import-Fehler:', e);
            }
        }

        // --- TYPE CALCULATOR FUNCTIONS ---
        function initTypeCalculator() {
            const gridContainer = document.getElementById('type-selection-grid-container');
            const grid = document.createElement('div');
            grid.className = 'type-selection-grid';
            gridContainer.appendChild(grid);
            allTypes.forEach(type => {
                const typeTag = document.createElement('span');
                typeTag.className = `type-tag type-${getTypeClassName(type)}`;
                typeTag.textContent = type;
                typeTag.dataset.type = type;
                typeTag.addEventListener('click', () => toggleTypeSelection(type));
                grid.appendChild(typeTag);
            });
            document.getElementById('clear-types-btn').addEventListener('click', clearTypeSelection);
            const type1Select = document.getElementById('pokedex-type1-filter');
            const type2Select = document.getElementById('pokedex-type2-filter');
            const allTypeOptions = `<option value="all">Typ 1</option>` + allTypes.map(t => `<option value="${t}">${t}</option>`).join('');
            type1Select.innerHTML = allTypeOptions;
            type2Select.innerHTML = allTypeOptions.replace('Typ 1', 'Typ 2');
            document.getElementById('pokedex-search').addEventListener('input', applyClickablePokedexFilters);
            type1Select.addEventListener('change', applyClickablePokedexFilters);
            type2Select.addEventListener('change', applyClickablePokedexFilters);
            applyClickablePokedexFilters();
            updateCalculatorResults();
        }
        function toggleTypeSelection(type) {
            const index = selectedTypes.indexOf(type);
            if (index > -1) {
                selectedTypes.splice(index, 1);
            } else if (selectedTypes.length < 2) {
                selectedTypes.push(type);
            }
            updateCalculatorUI();
        }
        function clearTypeSelection() {
            selectedTypes = [];
            updateCalculatorUI();
            clearStatsDisplay();
        }
        function updateCalculatorUI() {
            document.querySelectorAll('.type-selection-grid .type-tag').forEach(tag => {
                tag.classList.toggle('selected', selectedTypes.includes(tag.dataset.type));
            });
            updateCalculatorResults();
        }
        function updateCalculatorResults() {
            const defensiveResults = {};
            if (selectedTypes.length > 0) {
                allTypes.forEach(attackingType => {
                    let finalMultiplier = 1;
                    selectedTypes.forEach(defendingType => {
                        finalMultiplier *= typeMatchups[defendingType]?.[attackingType] ?? 1;
                    });
                    (defensiveResults[finalMultiplier] = defensiveResults[finalMultiplier] || []).push(attackingType);
                });
            }
            renderResults('defensive-results', defensiveResults);

            const offensiveResults = {};
            if (selectedTypes.length > 0) {
                allTypes.forEach(defendingType => {
                    selectedTypes.forEach(attackingType => {
                        const effectiveness = typeMatchups[defendingType]?.[attackingType] ?? 1;
                        if (!offensiveResults[effectiveness]) {
                            offensiveResults[effectiveness] = new Set();
                        }
                        offensiveResults[effectiveness].add(defendingType);
                    });
                });
            }
            renderResults('offensive-results', offensiveResults);
        }
        function renderResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = (Object.keys(results).length === 0 || selectedTypes.length === 0) ? '<p>Wähle Typ(en).</p>' : '';
            if (container.innerHTML !== '') return;
            const isDefensive = containerId === 'defensive-results';
            const textMap = isDefensive
                ? { 4: "Sehr effektiv (x4)", 2: "Sehr effektiv (x2)", 0.5: "Nicht sehr effektiv (x0.5)", 0.25: "Kaum effektiv (x0.25)", 0: "Immun (x0)" }
                : { 2: "Sehr effektiv (x2)", 0.5: "Nicht sehr effektiv (x0.5)", 0: "Keine Wirkung (x0)" };
            const order = isDefensive ? [4, 2, 0.5, 0.25, 0] : [2, 0.5, 0];

            order.forEach(multiplier => {
                const types = results[multiplier] ? Array.from(results[multiplier]).sort() : [];
                if (types.length > 0) {
                    const group = document.createElement('div');
                    group.className = 'effectiveness-group';
                    group.innerHTML = `<h4>${textMap[multiplier]}</h4>`;
                    const typesContainer = document.createElement('div');
                    typesContainer.className = 'pokemon-types';
                    types.forEach(type => {
                        typesContainer.innerHTML += `<span class="type-tag type-${getTypeClassName(type)}">${type}</span>`;
                    });
                    group.appendChild(typesContainer);
                    container.appendChild(group);
                }
            });
        }
        function renderClickablePokedex(list = pokemonList) {
            const container = document.getElementById('pokedex-clickable-container');
            container.innerHTML = '';
            list.forEach(p => {
                const card = document.createElement('div');
                card.className = 'pokemon-card';
                // Hier wurde 'formTag' hinzugefügt, um die Form-Tags auch im Typen-Rechner anzuzeigen
                let formTag = p.form !== 'Normal' ? `<span class="form-tag form-${p.form}">${p.form}</span>` : '';
                let typeTags = (p.type || "").split(' ').filter(Boolean).map(t => `<span class="type-tag type-${getTypeClassName(t)}">${t}</span>`).join('');
                card.innerHTML = `<div class="pokemon-header"><span class="pokemon-name">${p.name}</span>${formTag}<span>#${String(p.base_id).padStart(4, '0')}</span></div><div class="pokemon-types">${typeTags}</div>`;
                card.addEventListener('click', () => {
                    selectedTypes = (p.type || "").split(' ').filter(Boolean);
                    updateCalculatorUI();
                    renderStats(p);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                container.appendChild(card);
            });
        }
        function applyClickablePokedexFilters() {
            const searchText = document.getElementById('pokedex-search').value.toLowerCase();
            const type1 = document.getElementById('pokedex-type1-filter').value;
            const type2 = document.getElementById('pokedex-type2-filter').value;
            const filteredList = pokemonList.filter(p => {
                const types = (p.type || "").split(' ');
                return p.name.toLowerCase().includes(searchText) && (type1 === 'all' || types.includes(type1)) && (type2 === 'all' || types.includes(type2));
            });
            renderClickablePokedex(filteredList);
        }
        function clearStatsDisplay() {
            document.getElementById('stats-container').style.display = 'none';
        }
        function renderStats(pokemon) {
            const stats = pokemonStats.find(s => s.id === pokemon.id);
            const statsContainer = document.getElementById('stats-container');
            const statsDisplay = document.getElementById('stats-display');
            if (!stats) { clearStatsDisplay(); return; }
            statsContainer.style.display = 'block';
            const maxStatValue = 255;
            statsDisplay.innerHTML = `<div class="stats-grid">
                <span class="stat-label">KP:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.hp/maxStatValue)*100}%">${stats.hp}</div></div>
                <span class="stat-label">Angriff:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.attack/maxStatValue)*100}%">${stats.attack}</div></div>
                <span class="stat-label">Verteid.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.defense/maxStatValue)*100}%">${stats.defense}</div></div>
                <span class="stat-label">Sp. Ang.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.special_attack/maxStatValue)*100}%">${stats.special_attack}</div></div>
                <span class="stat-label">Sp. Vert.:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.special_defense/maxStatValue)*100}%">${stats.special_defense}</div></div>
                <span class="stat-label">Initiative:</span> <div class="stat-bar-background"><div class="stat-bar-fill" style="width:${(stats.speed/maxStatValue)*100}%">${stats.speed}</div></div>
                <span class="stat-label">Gesamt:</span> <span style="font-weight:bold;">${stats.total}</span>
            </div>`;
        }
        // Event Listener für Import/Export Buttons
        document.getElementById('exportCodeBtn').addEventListener('click', () => openCodeModal('export'));
        document.getElementById('importCodeBtn').addEventListener('click', () => openCodeModal('import'));
        document.getElementById('modalCloseBtn').addEventListener('click', () => document.getElementById('codeModal').style.display = 'none');
    </script>
</body>
</html>